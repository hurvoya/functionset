def build_stock_v2(df, events):
    """
    df : df_contrats_eligibles (filtré au threshold, avec dte_mel)
    events : new dealers détectés par compute_new_dealer_events_v2

    Retourne un df 'stock' avec :
    - 1 ligne par mois de suivi et par event_id
    - nb_calls et nb_contrats_eligibles par mois
    - arrêt du suivi à 8 contrats ou après 6 mois
    """

    rows = []

    df = df.sort_values(["id_apporteur", "dte_mel"]).copy()
    # mois de la mise en loyer
    df["mois_mel"] = df["dte_mel"].dt.to_period("M")

    for _, ev in events.iterrows():
        id_ap = ev["id_apporteur"]
        d0 = ev["dte_new_dealer"]
        event_id = ev["event_id"]
        new_dealer_type = ev["new_dealer_type"]

        # tous les contrats de ce dealer
        sub = df[df["id_apporteur"] == id_ap].copy()

        # on détermine les 6 mois de suivi : mois de d0 + 5 mois
        mois_start = d0.to_period("M")
        mois_periods = pd.period_range(start=mois_start, periods=6, freq="M")

        nb_contrats_cum = 0

        for mois in mois_periods:
            # contrats du mois courant
            sub_m = sub[sub["dte_mel"].dt.to_period("M") == mois]

            nb_contrats_mois = len(sub_m)
            nb_calls_mois = nb_contrats_mois  # 1 contrat = 1 call

            nb_contrats_cum += nb_contrats_mois

            dte_ref = mois.to_timestamp("M")  # fin de mois (stock au dernier jour du mois)

            rows.append(
                {
                    "id_apporteur": id_ap,
                    "event_id": event_id,
                    "dte_ref": dte_ref,
                    "nb_calls": nb_calls_mois,
                    "nb_contrats_eligibles": nb_contrats_mois,
                    "call_origin_type": new_dealer_type,
                    "en_suivi": True,   # on considère qu'il est en suivi sur les mois créés
                    "sorti_suivi": False,
                }
            )

            # on arrête dès qu'on atteint 8 contrats cumulés
            if nb_contrats_cum >= 8:
                break

    stock = pd.DataFrame(rows)
    return stock
