def compute_new_dealer_events_v2(df):
    df = df.sort_values(["id_apporteur", "dte_mel"]).copy()

    events = []

    for id_apporteur, grp in df.groupby("id_apporteur"):
        mel_dates = grp["dte_mel"].sort_values().tolist()

        previous_mel = None
        event_id = 0

        for d in mel_dates:
            if previous_mel is None:
                # FIRST TIME
                event_id += 1
                events.append({
                    "id_apporteur": id_apporteur,
                    "dte_new_dealer": d,
                    "new_dealer_type": "first",
                    "event_id": event_id
                })
                previous_mel = d
            else:
                # silence > 12 mois ?
                if (d - previous_mel).days > 365:
                    event_id += 1
                    events.append({
                        "id_apporteur": id_apporteur,
                        "dte_new_dealer": d,
                        "new_dealer_type": "known",
                        "event_id": event_id
                    })
                previous_mel = d

    events = pd.DataFrame(events)

    return events
