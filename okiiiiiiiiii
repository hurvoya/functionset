def compute_new_dealer_events_v2(df_prep):
    """
    df_prep : contrats éligibles (> threshold), avec au moins
              id_apporteur, dte_mel, country, ibl, is_key_account, dte_creation_v2

    Règle :
    - FIRST : premier contrat éligible de l'histoire du dealer
    - KNOWN : contrat éligible après >12 mois sans MEL éligible
    """

    df = df_prep.sort_values(["id_apporteur", "dte_mel", "id_contract"]).copy()

    events = []
    for id_apporteur, grp in df.groupby("id_apporteur"):
        previous_mel = None
        event_id = 0

        for _, row in grp.iterrows():
            d = row["dte_mel"]

            if previous_mel is None:
                # FIRST
                event_id += 1
                events.append(
                    {
                        "id_apporteur": id_apporteur,
                        "event_id": event_id,
                        "dte_new_dealer": d,
                        "new_dealer_type": "first",
                        "country": row["country"],
                        "ibl": row["ibl"],
                        "is_key_account": row["is_key_account"],
                        "dte_creation_apporteur": row["dte_creation_v2"],
                    }
                )
                previous_mel = d
            else:
                # silence > 12 mois ?
                if (d - previous_mel).days > 365:
                    event_id += 1
                    events.append(
                        {
                            "id_apporteur": id_apporteur,
                            "event_id": event_id,
                            "dte_new_dealer": d,
                            "new_dealer_type": "known",
                            "country": row["country"],
                            "ibl": row["ibl"],
                            "is_key_account": row["is_key_account"],
                            "dte_creation_apporteur": row["dte_creation_v2"],
                        }
                    )
                previous_mel = d

    events = pd.DataFrame(events)
    return events

