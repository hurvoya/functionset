def prepare_base_v2(df, threshold):
    """
    Prépare la base :
    - normalisation dates
    - filtrage contrats éligibles au threshold
    - keep only MEL/INS (date MEL obligatoire)
    """

    df = df.copy()

    # dates
    df["dte_mel"] = pd.to_datetime(df["dte_mel"], errors="coerce")
    df["dte_creation_v2"] = pd.to_datetime(df["dte_creation_v2"], errors="coerce")

    # BU = IBL
    df["ibl"] = df["ibl"].astype(str)

    # filtrage threshold strict
    df = df[df["mtd_total_lot"] > threshold].copy()

    # On ne garde que les lignes qui ont une MEL valide
    df = df[~df["dte_mel"].isna()].copy()

    # Tri
    df = df.sort_values(["id_apporteur", "dte_mel"])

    return df
