import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# base hors key accounts
calls_b4 = calls[~calls["is_key_account"]].copy()

# année
calls_b4["year"] = calls_b4["dte_mel"].dt.year

# agrégation par dealer / pays / IBL / année
dealer_activity = (
    calls_b4
    .groupby(["year", "country", "ibl", "id_apporteur"], as_index=False)
    .agg(
        nb_calls=("id_contract", "count"),
        montant_total=("mtd_total_lot", "sum"),
    )
)
