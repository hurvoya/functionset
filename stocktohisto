import pandas as pd

# Étape 1 : Renommer les clés pour préparer la fusion
df_contract_MEL = df_contract_MEL.rename(columns={'Contract Id': 'ID_COMMUN'})
df_request = df_request.rename(columns={'Request Id': 'ID_COMMUN'})

# Étape 2 : Merge full outer join
df_merged = pd.merge(
    df_contract_MEL,
    df_request,
    on='ID_COMMUN',
    how='outer',
    suffixes=('_contrat', '_request')
)

# Étape 3 : Flags de présence
df_merged['FLG_contrat'] = df_merged['Country_contrat'].notna().astype(int)
df_merged['FLG_request'] = df_merged['Country_request'].notna().astype(int)

# Étape 4 : Fusion des colonnes communes avec priorité Contrat > Request
colonnes_communes = [
    'Country', 'IBL', 'Organisme', 'Partner',
    'Financial Product', 'Commercial Product',
    'Market', 'Apporteur', 'Agence', 'Commercial'
]

for col in colonnes_communes:
    df_merged[col] = df_merged[f'{col}_contrat'].combine_first(df_merged[f'{col}_request'])

# Étape 5 : Nettoyage des colonnes dupliquées
colonnes_a_supprimer = [col for col in df_merged.columns if col.endswith('_contrat') or col.endswith('_request')]
df_final = df_merged.drop(columns=colonnes_a_supprimer)

# Résultat
print(df_final.head())
