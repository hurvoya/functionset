import pandas as pd

def build_calls_existing(events_existing, df_base, max_calls=8, follow_months=6):
    """
    events_existing: table enrichie (country, id_apporteur, snapshot_date, ibl, is_key_account, partner, ...)
    df_base: base contrats (country, id_apporteur, id_contract, dte_mel, mtd_total_lot, ibl, is_key_account, partner, dte_creation_apporteur)
    """
    ev = events_existing.copy()
    base = df_base.copy()

    ev["snapshot_date"] = pd.to_datetime(ev["snapshot_date"], errors="coerce")
    base["dte_mel"] = pd.to_datetime(base["dte_mel"], errors="coerce")

    # fenêtre de calls : [snapshot_date ; snapshot_date + 6 mois]
    ev["call_start"] = ev["snapshot_date"]
    ev["call_end"] = ev["snapshot_date"] + pd.DateOffset(months=follow_months)

    # merge events -> contrats
    m = ev.merge(
        base,
        on=["country", "id_apporteur"],
        how="left",
        suffixes=("", "_base")
    )

    # garder contrats dans la fenêtre post-snapshot
    m = m[
        (m["dte_mel"] >= m["call_start"]) &
        (m["dte_mel"] <= m["call_end"])
    ].copy()

    # ordonner les contrats (chronologique)
    # si plusieurs contrats même jour, on stabilise avec id_contract
    m = m.sort_values(["country", "id_apporteur", "snapshot_date", "dte_mel", "id_contract"])

    # rang du call dans la fenêtre
    m["call_rank"] = (
        m.groupby(["country", "id_apporteur", "snapshot_date"])
         .cumcount() + 1
    )

    # garder max_calls
    calls = m[m["call_rank"] <= max_calls].copy()

    # sélectionner colonnes utiles (style new dealer)
    cols = [
        "country", "ibl", "is_key_account", "partner",
        "id_apporteur", "snapshot_date",
        "dte_mel", "id_contract", "mtd_total_lot",
        "dte_creation_apporteur",
        "call_rank"
    ]
    cols = [c for c in cols if c in calls.columns]
    calls = calls[cols].copy()

    # renommage pour cohérence
    calls = calls.rename(columns={
        "snapshot_date": "dte_existing_event",
        "dte_mel": "dte_mel",
        "id_contract": "id_contract"
    })

    return calls
