import pandas as pd

def enrich_events_existing_business(events_existing, df_base, window_months=6):
    ev = events_existing.copy()
    base = df_base.copy()

    ev["snapshot_date"] = pd.to_datetime(ev["snapshot_date"], errors="coerce")
    base["dte_mel"] = pd.to_datetime(base["dte_mel"], errors="coerce")

    # fenêtre courante
    ev["current_start"] = (ev["snapshot_date"] - pd.DateOffset(months=window_months)) + pd.Timedelta(days=1)
    ev["current_end"] = ev["snapshot_date"]

    # join pour récupérer les contrats du dealer
    m = ev.merge(
        base,
        on=["country", "id_apporteur"],
        how="left",
        suffixes=("", "_base")
    )

    # garder uniquement les contrats dans la fenêtre courante
    m = m[(m["dte_mel"] >= m["current_start"]) & (m["dte_mel"] <= m["current_end"])].copy()

    # choisir le contrat de référence : dernier contrat de la fenêtre
    m = m.sort_values(["country", "id_apporteur", "snapshot_date", "dte_mel", "id_contract"])
    ref = (
        m.groupby(["country", "id_apporteur", "snapshot_date"], as_index=False)
         .tail(1)
         .copy()
    )

    # colonnes business qu'on remonte depuis le contrat ref
    business_cols = ["ibl", "is_key_account", "partner", "dte_creation_apporteur"]
    business_cols = [c for c in business_cols if c in ref.columns]

    # on ajoute id_contract_ref + dte_mel_ref
    ref = ref.rename(columns={
        "id_contract": "id_contract_ref",
        "dte_mel": "dte_mel_ref"
    })

    keep_cols = [c for c in ev.columns if c not in ["current_start", "current_end"]]  # on garde toutes les métriques déjà présentes
    keep_cols = [c for c in keep_cols if c in ref.columns]  # sécurise

    out_cols = (
        ["country", "id_apporteur", "snapshot_date"]
        + [c for c in keep_cols if c not in ["country","id_apporteur","snapshot_date"]]
        + ["id_contract_ref", "dte_mel_ref"]
        + business_cols
    )
    out_cols = [c for c in out_cols if c in ref.columns]

    out = ref[out_cols].copy()

    return out
