import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

YEARS = [2024, 2025]

def build_kpi_block1_volume(events, ibl=None):
    df = events.copy()

    # année (si elle n'existe pas, on la reconstruit depuis event_date)
    if "year" not in df.columns:
        df["event_date"] = pd.to_datetime(df["event_date"], errors="coerce")
        df["year"] = df["event_date"].dt.year

    # filtre années
    df = df[df["year"].isin(YEARS)].copy()

    # filtre IBL (Global si ibl=None)
    if ibl is not None:
        df = df[df["ibl"] == ibl].copy()

    # sécurité bool
    df["is_key_account"] = df["is_key_account"].astype(bool)

    # KPI : 1 dealer = 1 id_apporteur (distinct)
    kpi = (
        df.groupby(["country", "year", "is_key_account"], as_index=False)
          .agg(n_dealers=("id_apporteur", "nunique"))
    )

    return kpi
