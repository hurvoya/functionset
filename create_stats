import pandas as pd

def create_global_stats(df_event, df_ech):
    # Convertir les dates en datetime
    df_event['event_date'] = pd.to_datetime(df_event['event_date'])
    df_ech['date_loyer'] = pd.to_datetime(df_ech['date_loyer'])

    # Créer des colonnes 'month_year' pour les groupements
    df_event['month_year'] = df_event['event_date'].dt.to_period('M')
    df_ech['month_year'] = df_ech['date_loyer'].dt.to_period('M')

    # Calcul du nombre de prélèvements par mois-année
    nb_prelevement = df_ech.groupby('month_year').size().rename('nb_prelevement')

    # Calcul du nombre de RAV et de RAV OK par mois-année
    nb_de_RAV = df_event.groupby('month_year').size().rename('nb_de_RAV')
    nb_RAV_ok = df_event[df_event['RAV'] == 'RAV OK'].groupby('month_year').size().rename('nb_RAV_ok')

    # Concaténer les résultats en un seul dataframe
    global_stats = pd.concat([nb_prelevement, nb_de_RAV, nb_RAV_ok], axis=1).fillna(0)

    # Convertir les valeurs en entiers
    global_stats['nb_de_RAV'] = global_stats['nb_de_RAV'].astype(int)
    global_stats['nb_RAV_ok'] = global_stats['nb_RAV_ok'].astype(int)

    # Calcul du taux de succès
    global_stats['success_rate'] = (global_stats['nb_RAV_ok'] / global_stats['nb_de_RAV']).round(2)
    global_stats['success_rate'] = global_stats['success_rate'].replace([float('inf'), -float('inf')], 0).fillna(0)

    # Réinitialiser l'index
    global_stats = global_stats.reset_index()

    # Réorganiser le dataframe pour avoir les mois-année en colonnes
    global_stats = global_stats.melt(id_vars='month_year', var_name='Stats', value_name='Value')
    global_stats = global_stats.pivot(index='Stats', columns='month_year', values='Value').reset_index().fillna(0)

    return global_stats

# Exemple d'utilisation
# df_global_stats = create_global_stats(df_event, df_ech)
# print(df_global_stats)

__________________________________

def create_variable_stats(df_event):
    # Convertir la date en datetime
    df_event['event_date'] = pd.to_datetime(df_event['event_date'])
    
    # Créer des colonnes 'month_year' pour les groupements
    df_event['month_year'] = df_event['event_date'].dt.to_period('M')
    
    # Liste des variables à analyser
    variables = ['produit_contracte', 'marché', 'ibl', 'equipe_gestion']
    
    # DataFrame pour stocker les résultats
    all_stats = []

    for var in variables:
        # Calcul du nombre de RAV et de RAV OK par variable et par mois-année
        grouped = df_event.groupby([var, 'month_year'])
        nb_de_RAV = grouped.size().rename('nb_de_RAV')
        nb_RAV_ok = grouped.apply(lambda x: (x['RAV'] == 'RAV OK').sum()).rename('nb_RAV_ok')
        
        # Concaténer les résultats en un seul dataframe
        stats = pd.concat([nb_de_RAV, nb_RAV_ok], axis=1).fillna(0)
        
        # Convertir les valeurs en entiers
        stats['nb_de_RAV'] = stats['nb_de_RAV'].astype(int)
        stats['nb_RAV_ok'] = stats['nb_RAV_ok'].astype(int)

        # Calcul du taux de succès
        stats['success_rate'] = (stats['nb_RAV_ok'] / stats['nb_de_RAV']).round(2)
        stats['success_rate'] = stats['success_rate'].replace([float('inf'), -float('inf')], 0).fillna(0)
        
        # Ajouter la variable et sa valeur dans le dataframe
        stats = stats.reset_index()
        stats['variable'] = var
        stats = stats.rename(columns={var: 'valeur_variable'})
        
        # Ajouter au dataframe final
        all_stats.append(stats)

    # Concaténer tous les résultats
    variable_stats = pd.concat(all_stats, ignore_index=True)
    
    # Réarranger les colonnes pour avoir 'variable', 'valeur_variable', 'Stats' en premier
    variable_stats = variable_stats.melt(id_vars=['variable', 'valeur_variable', 'month_year'],
                                         value_vars=['nb_de_RAV', 'nb_RAV_ok', 'success_rate'],
                                         var_name='Stats', value_name='Value')
    
    # Réorganiser le dataframe pour avoir les mois-année en colonnes
    variable_stats = variable_stats.pivot_table(index=['variable', 'valeur_variable', 'Stats'],
                                                columns='month_year',
                                                values='Value').reset_index().fillna(0)
    
    # Filtrer les valeurs aberrantes
    variable_stats_filtered = variable_stats.copy()

    # Calculer le nombre de mois
    num_months = len(df_event['month_year'].unique())

    for var in variables:
        for stat in ['nb_de_RAV', 'success_rate']:
            mask = (variable_stats_filtered['variable'] == var) & (variable_stats_filtered['Stats'] == stat)
            df_stat = variable_stats_filtered[mask]

            # Si le nombre de valeurs de nb_de_RAV est inférieur à 5 fois le nombre de mois, supprimer la valeur_variable
            if df_stat[df_stat.columns[3:]].sum().sum() < 5 * num_months:
                variable_stats_filtered = variable_stats_filtered[~mask]

            # Si nb_de_RAV est inférieur à 5, mettre success_rate à NaN
            if stat == 'success_rate':
                for col in df_stat.columns[3:]:
                    if df_stat[col].sum() < 5:
                        variable_stats_filtered.loc[mask, col] = float('nan')

    return variable_stats_filtered

# Exemple d'utilisation
# df_variable_stats = create_variable_stats(df_event)
# print(df_variable_stats)
