# On part de df_client avec client_siren et client_sirette

# Optionnel : on enlève les lignes sans SIREN
tmp_sirette = df_client.dropna(subset=["client_siren"]).copy()

# Agrégat : pour chaque SIREN, on construit une liste de client_sirette
sirette_by_siren = (
    tmp_sirette
    .groupby("client_siren")["client_sirette"]
    .apply(lambda x: sorted(set(x.dropna())))  # liste unique, triée, sans NaN
    .rename("list_sirette")
    .reset_index()
    .rename(columns={"client_siren": "SIREN"})
)



tiers_flags = tiers_flags.merge(sirette_by_siren, on="SIREN", how="left")
