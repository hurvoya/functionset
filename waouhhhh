import pandas as pd

# Copie de travail
events_kpi = events.copy()

# Sécurité datetime
events_kpi["date_new_dealer"] = pd.to_datetime(
    events_kpi["date_new_dealer"], errors="coerce"
)
events_kpi["date_creation_apporteur"] = pd.to_datetime(
    events_kpi["date_creation_apporteur"], errors="coerce"
)

# Année d’analyse
events_kpi["year"] = events_kpi["date_new_dealer"].dt.year

# Filtre strict 2024–2025 + hors Key Account
events_kpi = events_kpi[
    (events_kpi["year"].isin([2024, 2025])) &
    (events_kpi["is_key_account"] == False)
].copy()

# Unicité dealer / année (sécurité)
events_kpi = (
    events_kpi
    .sort_values("date_new_dealer")
    .drop_duplicates(subset=["country", "year", "id_apporteur"])
)

# Calcul du délai en jours
events_kpi["delai_creation_to_first_mel"] = (
    events_kpi["date_new_dealer"] -
    events_kpi["date_creation_apporteur"]
).dt.days

# Nettoyage : garder uniquement les délais cohérents
kpi_bloc5 = events_kpi[
    events_kpi["delai_creation_to_first_mel"].notna() &
    (events_kpi["delai_creation_to_first_mel"] >= 0)
][
    ["country", "year", "id_apporteur", "delai_creation_to_first_mel"]
].copy()
