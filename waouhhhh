kpi_new_dealer = (
    events
    .assign(
        year_month=events["date_new_dealer"].dt.to_period("M").astype(str)
    )
    .groupby(["country", "year_month"])
    .agg(
        nb_new_dealers=("id_apporteur", "nunique"),
        nb_new_dealers_key_account=("is_key_account", "sum")
    )
    .reset_index()
)

kpi_new_dealer["share_key_account"] = (
    kpi_new_dealer["nb_new_dealers_key_account"]
    / kpi_new_dealer["nb_new_dealers"]
)
