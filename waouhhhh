import matplotlib.pyplot as plt
import numpy as np

def plot_scatter_calls_vs_amount(df, year):
    df_year = df[df["year"] == year].copy()

    # Cap Y-axis (anti outliers)
    y_max = df_year["montant_finance_total"].quantile(0.95)

    plt.figure(figsize=(10, 6))

    for country in df_year["country"].unique():
        sub = df_year[df_year["country"] == country]
        plt.scatter(
            sub["nb_calls_total"],
            sub["montant_finance_total"],
            alpha=0.6,
            label=country
        )

    # Règle métier : 8 calls max
    plt.axvline(
        x=8,
        linestyle="--",
        linewidth=1.5,
        label="Seuil métier : 8 calls"
    )

    plt.ylim(0, y_max)
    plt.xlabel("Nombre total de calls (fenêtre de suivi)")
    plt.ylabel("Montant financé total (€)")
    plt.title(f"Calls vs Montant financé — {year} (hors Key Account)")
    plt.legend()
    plt.grid(alpha=0.3)

    plt.tight_layout()
    plt.show()
