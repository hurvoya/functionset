kpi_delay_creation = (
    events_no_ka
    .assign(
        delay_days=(
            events_no_ka["date_new_dealer"]
            - events_no_ka["date_creation_apporteur"]
        ).dt.days,
        year_month=events_no_ka["date_creation_apporteur"].dt.to_period("M").astype(str)
    )
    .groupby(["country", "year_month"])
    .agg(
        avg_delay_days=("delay_days", "mean"),
        median_delay_days=("delay_days", "median")
    )
    .reset_index()
)
