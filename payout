Touch_Category :=
SWITCH(
    TRUE(),
    Spotfire[Nb of touch (total)] = 0, "1-No Touch",
    Spotfire[Nb of touch (internal)] > 0 && Spotfire[Nb of touch (external)] = 0, "2-Internal only",
    Spotfire[Nb of touch (internal)] = 0 && Spotfire[Nb of touch (external)] > 0, "3-External only",
    Spotfire[Nb of touch (internal)] > 0 && Spotfire[Nb of touch (external)] > 0, "4-Both",
    "5-Unclassified"
)


Nb_Contracts_Touch_Category :=
CALCULATE(
    DISTINCTCOUNT(Spotfire[Contract Id]),
    Spotfire[Flag_Country] = 1,
    Spotfire[FLG_MEL_Valide] = 1,
    TREATAS(VALUES(Fait_All[Country]), Spotfire[Country]),
    TREATAS(VALUES(Fait_All[IBL]), Spotfire[IBL]),
    TREATAS(VALUES(Fait_All[Organisme]), Spotfire[Organisme]),
    TREATAS(VALUES(Fait_All[Partner]), Spotfire[Partner]),
    TREATAS(VALUES(Fait_All[Financial Product]), Spotfire[Financial Product]),
    TREATAS(VALUES(Fait_All[Commercial Product]), Spotfire[Commercial Product]),
    TREATAS(VALUES(Fait_All[Market]), Spotfire[Market]),
    TREATAS(VALUES(Fait_All[Apporteur]), Spotfire[Apporteur]),
    TREATAS(VALUES(Fait_All[Agence]), Spotfire[Agence])
)

%_Contracts_Touch_Category :=
DIVIDE(
    [Nb_Contracts_Touch_Category],
    CALCULATE(
        DISTINCTCOUNT(Spotfire[Contract Id]),
        Spotfire[Flag_Country] = 1,
        Spotfire[FLG_MEL_Valide] = 1,
        REMOVEFILTERS(Spotfire[Touch_Category]), -- ✅ ignore le filtre catégorie
        TREATAS(VALUES(Fait_All[Country]), Spotfire[Country]),
        TREATAS(VALUES(Fait_All[IBL]), Spotfire[IBL]),
        TREATAS(VALUES(Fait_All[Organisme]), Spotfire[Organisme]),
        TREATAS(VALUES(Fait_All[Partner]), Spotfire[Partner]),
        TREATAS(VALUES(Fait_All[Financial Product]), Spotfire[Financial Product]),
        TREATAS(VALUES(Fait_All[Commercial Product]), Spotfire[Commercial Product]),
        TREATAS(VALUES(Fait_All[Market]), Spotfire[Market]),
        TREATAS(VALUES(Fait_All[Apporteur]), Spotfire[Apporteur]),
        TREATAS(VALUES(Fait_All[Agence]), Spotfire[Agence])
    )
)

