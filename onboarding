import pandas as pd
import numpy as np

def build_nd_windows_from_onboarding_calls(
    calls_onboarding_audit: pd.DataFrame,
    follow_months: int = 6,
    max_eligible_calls: int = 8
) -> pd.DataFrame:
    """
    Construit la table nd_windows à partir des calls onboarding (audit complet).
    Output: id_apporteur, start_date, end_date
    """
    df = calls_onboarding_audit.copy()

    # Dates
    df["dte_new_dealer"] = pd.to_datetime(df["dte_new_dealer"], errors="coerce")
    df["dte_trigger"] = pd.to_datetime(df["dte_trigger"], errors="coerce")

    # Sécurité
    df = df.dropna(subset=["id_apporteur", "event_id", "dte_new_dealer"])

    # Start = date ND
    start = (
        df.groupby(["id_apporteur", "event_id"], as_index=False)["dte_new_dealer"]
          .min()
          .rename(columns={"dte_new_dealer": "start_date"})
    )

    # End par défaut = start + 6 mois
    start["end_default"] = start["start_date"] + pd.DateOffset(months=follow_months)

    # Date du 8e call éligible (si existe)
    # -> on cherche la ligne éligible avec eligible_call_rank == 8
    if "eligible_call_rank" in df.columns:
        df_rank = df[df["eligible_call_rank"] == max_eligible_calls].copy()
        # la date "du 8e call" : c'est dte_trigger de cette ligne
        end_8 = (
            df_rank.groupby(["id_apporteur", "event_id"], as_index=False)["dte_trigger"]
                  .min()
                  .rename(columns={"dte_trigger": "end_8calls"})
        )
    else:
        # fallback si tu n'as pas eligible_call_rank : on le recalcule vite
        df = df.sort_values(["id_apporteur", "event_id", "dte_trigger"])
        df["is_call_eligible"] = df["is_call_eligible"].fillna(False).astype(bool)
        df["eligible_call_rank"] = df.groupby(["id_apporteur","event_id"])["is_call_eligible"].cumsum()

        df_rank = df[df["eligible_call_rank"] == max_eligible_calls].copy()
        end_8 = (
            df_rank.groupby(["id_apporteur", "event_id"], as_index=False)["dte_trigger"]
                  .min()
                  .rename(columns={"dte_trigger": "end_8calls"})
        )

    # Merge + end_date = min(end_default, end_8calls) si end_8calls existe
    w = start.merge(end_8, on=["id_apporteur", "event_id"], how="left")

    w["end_date"] = np.where(
        w["end_8calls"].notna(),
        np.minimum(w["end_default"].values.astype("datetime64[ns]"),
                   w["end_8calls"].values.astype("datetime64[ns]")),
        w["end_default"].values.astype("datetime64[ns]")
    )
    w["end_date"] = pd.to_datetime(w["end_date"])

    # Format final
    nd_windows = w[["id_apporteur", "start_date", "end_date"]].copy()

    # Optionnel: si tu veux exclure un growth event si snapshot tombe le jour même de end_date
    # -> on laisse end_date inclusif (c'est ce qu'on fait partout)
    return nd_windows
